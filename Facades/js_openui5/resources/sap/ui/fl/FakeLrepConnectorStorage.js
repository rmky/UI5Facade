/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/FakeLrepConnector","sap/ui/fl/LrepConnector","sap/ui/fl/Cache","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils"],function(F,L,C,a,U){"use strict";return function(f){b._oBackendInstances={};function b(S){this.mSettings=Object.assign({isKeyUser:true,isAtoAvailable:false,isProductiveSystem:false},S);this._iChangeCounter=0;}Object.assign(b.prototype,F.prototype);b.prototype.create=function(v){var r;if(Array.isArray(v)){r=v.map(function(m){return this._saveChange(m);}.bind(this));}else{r=this._saveChange(v);}return Promise.resolve({response:r,status:'success'});};b.prototype._saveChange=function(m){var n;if(!m.creation){n=Date.now()+this._iChangeCounter++;m.creation=new Date(n).toISOString();}f.saveChange(m.fileName,m);return m;};b.prototype.update=function(m){return Promise.resolve({response:this._saveChange(m),status:'success'});};b.prototype.send=function(){return F.prototype.send.apply(this,arguments);};b.prototype.resetChanges=function(p){function _(o){var D=true;if(p.aSelectorIds){if(o.selector){D=p.aSelectorIds.indexOf(o.selector.id)>-1;}else{D=false;}}if(D&&p.aChangeTypes){D=p.aChangeTypes.indexOf(o.changeType)>-1;}return D;}return this.send(this._getUrlPrefix(),"DELETE").then(function(){var r=[];f.getChanges(p.sReference,p.sLayer).forEach(function(o){if(_(o)){r.push({layer:o.layer,name:o.fileName,namespace:o.namespace,type:o.fileType});f.deleteChange(o.fileName);}});return{response:r,status:"success"};});};b.prototype.deleteChange=function(o){f.deleteChange(o.sChangeName);return Promise.resolve({response:undefined,status:"nocontent"});};b.prototype.deleteChanges=function(){f.deleteChanges();return Promise.resolve({response:undefined,status:"nocontent"});};b.prototype.loadChanges=function(m,p,B){var e=f.getChanges(m.name);if(B){e=e.concat(B);}return new Promise(function(r,g){var R={};if(this.mSettings.sInitialComponentJsonPath){jQuery.getJSON(this.mSettings.sInitialComponentJsonPath).done(function(o){R={changes:o,componentClassName:m.name};r(R);}).fail(function(h){g(h);});}else{r(R);}}.bind(this)).then(function(r){var v=[];var g=[];var h=[];var i=[];e.forEach(function(o){if(o.fileType==="ctrl_variant"&&o.variantManagementReference){v.push(o);}else if(o.fileType==="ctrl_variant_change"){g.push(o);}else if(o.fileType==="ctrl_variant_management_change"){h.push(o);}else{i.push(o);}});r=this._createChangesMap(r,v);r=this._addChangesToMap(r,i,g,h);r=this._sortChanges(r);r=this._assignVariantReferenceChanges(r);r.changes.contexts=[];r.changes.settings=this.mSettings;r.componentClassName=m.name;return r;}.bind(this));};b.prototype._createChangesMap=function(r,v){if(!r||!r.changes){r={changes:{}};}if(!r.changes.changes){r.changes.changes=[];}if(!r.changes.variantSection){r.changes.variantSection={};}var e=function(E,n){return E.some(function(o){return o.content.fileName===n.fileName;});};var V={};v.forEach(function(o){V=r.changes.variantSection[o.variantManagementReference];if(!V){var S=this._fakeStandardVariant(o.variantManagementReference);V=this._getVariantManagementStructure([this._getVariantStructure(S,[],{}),this._getVariantStructure(o,[],{})],{});r.changes.variantSection[o.variantManagementReference]=V;}else if(!e(V.variants,o)){V.variants.push(this._getVariantStructure(o,[],{}));}}.bind(this));return r;};b.prototype._getVariantStructure=function(v,e,V){return{content:v,controlChanges:e,variantChanges:V};};b.prototype._getVariantManagementStructure=function(v,V){return{variants:v,variantManagementChanges:V};};function s(A){A.sort(c);}function c(o,e){var l=U.getLayerIndex(o.layer);var i=U.getLayerIndex(e.layer);if(l!==i){return l-i;}return new Date(o.creation)-new Date(e.creation);}b.prototype._sortChanges=function(r){if(r.changes.changes){s(r.changes.changes);}d(r,function(v){s(v.controlChanges);});return r;};function d(r,e){Object.keys(r.changes.variantSection).forEach(function(v){var V=r.changes.variantSection[v].variants;V.forEach(e);});}b.prototype._assignVariantReferenceChanges=function(r){d(r,function(v){var V=v.content.variantReference;var e=v.controlChanges;if(V){e=this._getReferencedChanges(r,v).concat(e);}v.controlChanges=e;}.bind(this));return r;};function w(r,v,V,e){r.changes.variantSection[v].variants.some(function(o){if(o.content.fileName===V){e(o);return true;}});}b.prototype._getReferencedChanges=function(r,o){var R=[];w(r,o.content.variantManagementReference,o.content.variantReference,function(v){R=v.controlChanges.filter(function(e){return U.compareAgainstCurrentLayer(e.layer,o.layer)===-1;});if(v.content.variantReference){R=R.concat(this._getReferencedChanges(r,v));}}.bind(this));return R;};b.prototype._addChangesToMap=function(r,e,g,h){var A=function(r,V,o){w(r,V,o.variantReference,function(k){k.controlChanges.push(o);});};var i=function(r,V,o){w(r,V,o.selector.id,function(k){if(!k.variantChanges[o.changeType]){k.variantChanges[o.changeType]=[];}k.variantChanges[o.changeType].push(o);});};function j(r,V){return Object.keys(r.changes.variantSection).some(function(k){var l=r.changes.variantSection[k].variants;return l.some(function(o){return o.content.fileName===V;});});}var v={};h.forEach(function(V){var k=V.selector.id;if(!r.changes.variantSection[k]){r.changes.variantSection[k]=this._getVariantManagementStructure([this._getVariantStructure(this._fakeStandardVariant(k),[],{})],{});}v=r.changes.variantSection[k].variantManagementChanges;if(!v[V.changeType]){v[V.changeType]=[];}v[V.changeType].push(V);}.bind(this));e.forEach(function(o){if(!o.variantReference){r.changes.changes.push(o);}else if(!j(r,o.variantReference)){r.changes.variantSection[o.variantReference]=this._getVariantManagementStructure([this._getVariantStructure(this._fakeStandardVariant(o.variantReference),[o],{})],{});}else{Object.keys(r.changes.variantSection).forEach(function(V){A(r,V,o);});}}.bind(this));g.forEach(function(V){if(!j(r,V.selector.id)){var m={};m[V.changeType]=[V];r.changes.variantSection[V.selector.id]=this._getVariantManagementStructure([this._getVariantStructure(this._fakeStandardVariant(V.selector.id),[],m)],{});}else{Object.keys(r.changes.variantSection).forEach(function(k){i(r,k,V);});}}.bind(this));return r;};b.prototype._fakeStandardVariant=function(v){return{fileName:v,fileType:"ctrl_variant",variantManagementReference:v,variantReference:"",content:{title:sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl").getText("STANDARD_VARIANT_TITLE")}};};b.enableFakeConnector=function(S,A,e,g){S=S||{};function r(){b.enableFakeConnector.original=L.createConnector;L.createConnector=function(){if(!b._oFakeInstance){b._oFakeInstance=new b(S);}return b._oFakeInstance;};}if(A&&e){var o=a.getChangePersistenceForComponent(A,e);if(!(o._oConnector instanceof b)){if(!g){b.clearCacheAndResetVariants(A,e,o);}if(!b._oBackendInstances[A]){b._oBackendInstances[A]={};}b._oBackendInstances[A][e]=o._oConnector;o._oConnector=new b(S);}r();return;}if(!g){C.clearEntries();}if(b.enableFakeConnector.original){return;}r();};b.disableFakeConnector=function(A,e){function r(){if(b.enableFakeConnector.original){L.createConnector=b.enableFakeConnector.original;b.enableFakeConnector.original=undefined;b._oFakeInstance=undefined;}}if(A&&e){var o=a.getChangePersistenceForComponent(A,e);if(!(o._oConnector instanceof L)){b.clearCacheAndResetVariants(A,e,o);if(b._oBackendInstances[A]&&b._oBackendInstances[A][e]){o._oConnector=b._oBackendInstances[A][e];b._oBackendInstances[A][e]=undefined;}}r();return;}C.clearEntries();r();};b.clearCacheAndResetVariants=function(e,A,o){C.clearEntry(e,A);o.resetVariantMap(true);};return b;};},true);
