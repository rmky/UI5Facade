/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/Device','sap/ui/base/EventProvider','sap/ui/core/InvisibleText','sap/ui/core/ListItem','sap/ui/core/ResizeHandler','sap/ui/core/ValueStateSupport','sap/m/library','sap/ui/core/library','sap/m/Bar','sap/m/Toolbar','sap/m/Button','sap/m/ToggleButton','sap/m/ColumnListItem','sap/m/GroupHeaderListItem','sap/ui/core/SeparatorItem','sap/m/Dialog','sap/m/DisplayListItem','sap/m/List','sap/m/Popover','sap/m/StandardListItem','sap/m/Table','sap/m/Title','sap/m/Text','sap/ui/core/IconPool','sap/m/SimpleFixFlex',"sap/base/security/encodeXML","sap/ui/events/KeyCodes"],function(D,E,I,L,R,V,l,c,B,T,a,b,C,G,S,d,e,f,P,g,h,j,k,m,n,o,K){"use strict";var p=l.ListMode;var q=l.PlacementType;var r=l.ListType;var s=l.ListSeparators;var t="sapMSuggestionsPopover",u="sapUiNoContentPadding";var v=c.ValueState;var w=E.extend("sap.m.SuggestionsPopover",{constructor:function(i){E.apply(this,arguments);this._oInput=i;this._bHasTabularSuggestions=false;this._bUseDialog=D.system.phone;this._iPopupListSelectedIndex=-1;this._sPopoverContentWidth=null;this._bEnableHighlighting=true;this._bIsInputIncrementalType=false;this._bAutocompleteEnabled=false;this._sTypedInValue='';this._sOldValueState=v.None;this._oInput.addEventDelegate({onsapup:function(x){this._onsaparrowkey(x,"up",1);},onsapdown:function(x){this._onsaparrowkey(x,"down",1);},onsappageup:function(x){this._onsaparrowkey(x,"up",5);},onsappagedown:function(x){this._onsaparrowkey(x,"down",5);},onsaphome:function(x){if(this._oList){this._onsaparrowkey(x,"up",this._oList.getItems().length);}},onsapend:function(x){if(this._oList){this._onsaparrowkey(x,"down",this._oList.getItems().length);}},onsapright:this._onsapright},this);},destroy:function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}if(this._oList){this._oList.destroy();this._oList=null;}this._oProposedItem=null;this._oInputDelegate=null;if(this._oPickerValueStateText){this._oPickerValueStateText.destroy();this._oPickerValueStateText=null;}}});w.M_EVENTS={SELECTION_CHANGE:"selectionChange"};w._wordStartsWithValue=function(i,x){var y;if(!i||!x||typeof i!=="string"||typeof x!=="string"){return false;}while(i){if(typeof x==="string"&&x!==""&&i.toLowerCase().indexOf(x.toLowerCase())===0){return true;}y=i.indexOf(' ');if(y===-1){break;}i=i.substring(y+1);}return false;};w._DEFAULTFILTER=function(i,x){if(x instanceof L&&w._wordStartsWithValue(x.getAdditionalText(),i)){return true;}return w._wordStartsWithValue(x.getText(),i);};w.prototype.isOpen=function(){return this._oPopover&&this._oPopover.isOpen();};w.prototype.setInputLabels=function(i){this._fnInputLabels=i;};w.prototype._getInputLabels=function(){return this._fnInputLabels();};w.prototype._getScrollableContent=function(){var i=this._oSimpleFixFlex&&this._oSimpleFixFlex.getDomRef(),x=i&&i.querySelector('.sapUiSimpleFixFlexFlexContent');return x;};w.prototype.updatePickerHeaderTitle=function(){var i=sap.ui.getCore().getLibraryResourceBundle("sap.m"),x=this.getPickerTitle(),y,z;if(!x){return;}z=this._getInputLabels();if(z.length){y=z[0];if(y&&(typeof y.getText==="function")){x.setText(y.getText());}}else{x.setText(i.getText("COMBOBOX_PICKER_TITLE"));}return x;};w.prototype.getPickerTitle=function(){return this._oPopover.getCustomHeader().getContentMiddle()[0];};w.prototype.getOkButton=function(){var i=this._oPopover&&this._oPopover.getBeginButton();return i||null;};w.prototype.getCancelButton=function(){var i=this._oPopover&&this._oPopover.getCustomHeader()&&this._oPopover.getCustomHeader().getContentRight()[0];return i||null;};w.prototype.getFilterSelectedButton=function(){var i=this._oPopover&&this._oPopover.getSubHeader()&&this._oPopover.getSubHeader().getContent()[1];return i||null;};w.prototype._createFilterSelectedButton=function(){var i=m.getIconURI("multiselect-all");return new b({icon:i});};w.prototype._createSuggestionPopup=function(O){O=O||[];var i=this._oInput,x=this,M=i._oRb;this._oPopover=!this._bUseDialog?(new P(i.getId()+"-popup",{showArrow:false,placement:q.VerticalPreferredBottom,showHeader:false,initialFocus:i,horizontalScrolling:true})):(new d(i.getId()+"-popup",{beginButton:new a(i.getId()+"-popup-closeButton",{text:M.getText("SUGGESTIONSPOPOVER_CLOSE_BUTTON")}),stretch:true,customHeader:new B(i.getId()+"-popup-header",{contentMiddle:new j(),contentRight:new a({icon:m.getIconURI("decline")})}),subHeader:this.createSubHeaderContent(O),horizontalScrolling:false,initialFocus:this._oPopupInput,beforeOpen:function(){x.updatePickerHeaderTitle();},afterClose:function(){i.focus();l.closeKeyboard();}}));this._registerAutocomplete();this._oPopover.addStyleClass(t);this._oPopover.addStyleClass(u);this._oPopover.addAriaLabelledBy(I.getStaticId("sap.m","INPUT_AVALIABLE_VALUES"));if(!this._bUseDialog){this._overwritePopover();}if(this._oList){this._oPopover.addContent(this._oList);}};w.prototype.createSubHeaderContent=function(O){var i=[this._oPopupInput];if(O.showSelectedButton){i.push(this._createFilterSelectedButton());}return new T({content:i});};w.prototype._createSuggestionPopupContent=function(i){var x=this._oInput;this._bHasTabularSuggestions=i;if(!i){this._oList=new f(x.getId()+"-popup-list",{showNoData:false,mode:p.SingleSelectMaster,rememberSelections:false,width:"100%",showSeparators:s.None,busyIndicatorDelay:0});this._oList.addEventDelegate({onAfterRendering:function(){var A,F;if(!this._bEnableHighlighting){return;}A=this._oList.$().find('.sapMDLILabel, .sapMSLITitleOnly, .sapMDLIValue');F=(this._sTypedInValue||this._oInput.getValue()).toLowerCase();this.highlightSuggestionItems(A,F);}.bind(this)});}else{this._oList=this._oInput._getSuggestionsTable();}this._oSimpleFixFlex=this._createSimpleFixFlex();if(this._oPopover){if(this._bUseDialog){this._oPopover.addAggregation("content",this._oSimpleFixFlex,true);var y=this._oPopover.$("scrollCont")[0];if(y){var z=sap.ui.getCore().createRenderManager();z.renderControl(this._oSimpleFixFlex);z.flush(y);z.destroy();}}else{this._oPopover.addContent(this._oSimpleFixFlex);}}};w.prototype._destroySuggestionPopup=function(){if(this._oPopover){if(this._oList instanceof h){this._oPopover.removeAllContent();}this._oPopover.destroy();this._oPopover=null;}if(this._oList instanceof f){this._oList.destroy();this._oList=null;}if(this._oPickerValueStateText){this._oPickerValueStateText.destroy();this._oPickerValueStateText=null;}this._getInput().removeEventDelegate(this._oInputDelegate,this);};w.prototype._overwritePopover=function(){var i=this._oInput;this._oPopover.open=function(){this.openBy(i,false,true);};this._oPopover.oPopup.setAnimations(function($,x,O){O();},function($,x,y){y();});};w.prototype._resizePopup=function(){var i=this._oInput;if(this._oList&&this._oPopover){if(this._sPopoverContentWidth){this._oPopover.setContentWidth(this._sPopoverContentWidth);}else{this._oPopover.setContentWidth((i.$().outerWidth())+"px");}setTimeout(function(){if(this._oPopover&&this._oPopover.isOpen()&&this._oPopover.$().outerWidth()<i.$().outerWidth()){this._oPopover.setContentWidth((i.$().outerWidth())+"px");}}.bind(this),0);}};w.prototype._registerResize=function(){if(!this._bUseDialog){this._sPopupResizeHandler=R.register(this._oInput,this._resizePopup.bind(this));}};w.prototype._deregisterResize=function(){if(this._sPopupResizeHandler){this._sPopupResizeHandler=R.deregister(this._sPopupResizeHandler);}};w.prototype._onsaparrowkey=function(i,x,y){var z=this._oInput,A,F=z.$("inner");if(i.isMarked()){return;}if(i.isMarked()){return;}if(!z.getEnabled()||!z.getEditable()){return;}if(x!=="up"&&x!=="down"){return;}if(this._bIsInputIncrementalType){i.setMarked();}if(!this._oPopover||!this._oPopover.isOpen()){return;}i.preventDefault();i.stopPropagation();var H=false,J=this._oList,M=J.getItems(),N=this._iPopupListSelectedIndex,O,Q=N;if(x==="up"&&N===0){return;}if(x=="down"&&N===M.length-1){return;}var U;if(y>1){if(x=="down"&&N+y>=M.length){x="up";y=1;M[N].setSelected(false);U=N;N=M.length-1;H=true;}else if(x=="up"&&N-y<0){x="down";y=1;M[N].setSelected(false);U=N;N=0;H=true;}}if(N===-1){N=0;if(this._isSuggestionItemSelectable(M[N])){Q=N;H=true;}else{x="down";}}if(x==="down"){while(N<M.length-1&&(!H||!this._isSuggestionItemSelectable(M[N]))){M[N].setSelected(false);N=N+y;H=true;y=1;if(U===N){break;}}}else{while(N>0&&(!H||!M[N].getVisible()||!this._isSuggestionItemSelectable(M[N]))){M[N].setSelected(false);N=N-y;H=true;y=1;if(U===N){break;}}}if(!this._isSuggestionItemSelectable(M[N])){if(Q>=0){M[Q].setSelected(true).updateAccessibilityState();F.attr("aria-activedescendant",M[Q].getId());}return;}else{A=M[N];A.setSelected(true).updateAccessibilityState();if(A.isA("sap.m.GroupHeaderListItem")){F.removeAttr("aria-activedescendant");}else{F.attr("aria-activedescendant",M[N].getId());}}if(D.system.desktop){this._scrollToItem(N);}this._oLastSelectedHeader&&this._oLastSelectedHeader.removeStyleClass("sapMInputFocusedHeaderGroup");if(C&&M[N]instanceof C){O=z._getInputValue(z._fnRowResultFilter(M[N]));}else{if(M[N].isA("sap.m.GroupHeaderListItem")){O="";M[N].addStyleClass("sapMInputFocusedHeaderGroup");this._oLastSelectedHeader=M[N];}else if(M[N]instanceof e){O=z._getInputValue(M[N].getLabel());}else{O=z._getInputValue(M[N].getTitle());}}this._iPopupListSelectedIndex=N;this._bSuggestionItemChanged=true;this.fireEvent(w.M_EVENTS.SELECTION_CHANGE,{newValue:O});};w.prototype._isSuggestionItemSelectable=function(i){var x=this._bHasTabularSuggestions||i.getType()!==r.Inactive||i.isA("sap.m.GroupHeaderListItem");return i.getVisible()&&x;};w.prototype.setOkPressHandler=function(H){var O=this.getOkButton();O&&O.attachPress(H);return O;};w.prototype.setCancelPressHandler=function(H){var i=this.getCancelButton();i&&i.attachPress(H);};w.prototype.setShowSelectedPressHandler=function(H){var F=this.getFilterSelectedButton();F&&F.attachPress(H);return F;};w.prototype._scrollToItem=function(i){var x=this._oPopover,y=this._oList,z,A,F,H,J;if(!(x instanceof P)||!y){return;}z=x.getScrollDelegate();if(!z){return;}var M=y.getItems()[i],N=M&&M.getDomRef();if(!N){return;}A=x.getDomRef("cont").getBoundingClientRect();F=N.getBoundingClientRect();H=A.top-F.top;J=F.bottom-A.bottom;if(H>0){z.scrollTo(z._scrollX,Math.max(z._scrollY-H,0));}else if(J>0){z.scrollTo(z._scrollX,z._scrollY+J);}};w.prototype._createHighlightedText=function(i,x,W){var y,z,A,N,F,H=i?i.innerText:"",J="";if(!w._wordStartsWithValue(H,x)){return o(H);}x=x.toLowerCase();A=x.length;while(w._wordStartsWithValue(H,x)){y=H.toLowerCase();z=y.indexOf(x);z=(z>0)?y.indexOf(' '+x)+1:z;F=H.substring(0,z);H=H.substring(z);J+=o(F);F=H.substring(0,A);H=H.substring(A);J+='<span class="sapMInputHighlight">'+o(F)+'</span>';N=H.indexOf(" ");N=N===-1?H.length:N;F=H.substring(0,N);H=H.substring(N);J+=o(F);if(!W){break;}}if(H){J+=o(H);}return J;};w.prototype._createSimpleFixFlex=function(){var i=this._oInput.getId()+"-simplefixflex";return new n({id:i,fixContent:this._getPickerValueStateText(),flexContent:this._oList});};w.prototype.highlightSuggestionItems=function(x,y,W){var i;if(!this._bEnableHighlighting||(!x&&!x.length)){return;}for(i=0;i<x.length;i++){x[i].innerHTML=this._createHighlightedText(x[i],y,W);}};w.prototype._registerAutocomplete=function(){var i=this._oPopover,U=this._getInput(),x=this._bUseDialog;if(x){i.addEventDelegate({ontap:function(){if(!this._bSuggestionItemTapped&&this._sProposedItemText){U.setValue(this._sProposedItemText);this._sProposedItemText=null;}}},this);}else{i.attachAfterOpen(this._handleTypeAhead,this);}i.attachAfterOpen(this._setSelectedSuggestionItem,this);i.attachAfterClose(this._finalizeAutocomplete,this);this._oInputDelegate={onkeydown:function(y){this._bDoTypeAhead=this._bAutocompleteEnabled&&(y.which!==K.BACKSPACE)&&(y.which!==K.DELETE);},oninput:this._handleTypeAhead};U.addEventDelegate(this._oInputDelegate,this);};w.prototype._handleTypeAhead=function(){var x=this._getInput(),y=x.getValue();this._oProposedItem=null;this._sProposedItemText=null;this._sTypedInValue=y;if(!this._bDoTypeAhead||y===""){return;}if(!this._oPopover.isOpen()||y.length<this._oInput.getStartSuggestion()){return;}if(document.activeElement!==x.getFocusDomRef()){return;}var z=y.toLowerCase(),A=this._bHasTabularSuggestions?this._oInput.getSuggestionRows():this._oInput.getSuggestionItems(),F,N,H,i;A=A.filter(function(J){return!(J.isA("sap.ui.core.SeparatorItem")||J.isA("sap.m.GroupHeaderListItem"));});F=A.length;for(i=0;i<F;i++){H=this._bHasTabularSuggestions?this._oInput._fnRowResultFilter(A[i]):A[i].getText();if(H.toLowerCase().indexOf(z)===0){this._oProposedItem=A[i];N=H;break;}}this._sProposedItemText=N;if(N){N=this._formatTypedAheadValue(N);if(!x.isComposingCharacter()){x.updateDomValue(N);}if(D.system.desktop){x.selectText(y.length,N.length);}else{setTimeout(function(){x.selectText(y.length,N.length);},0);}}};w.prototype._setSelectedSuggestionItem=function(){var F;if(this._oList){F=this._oList.getItems();for(var i=0;i<F.length;i++){if((F[i]._oItem||F[i])===this._oProposedItem){F[i].setSelected(true);break;}}}};w.prototype._getInput=function(){return this._bUseDialog?this._oPopupInput:this._oInput;};w.prototype._finalizeAutocomplete=function(){if(this._oInput.isComposingCharacter()){return;}if(!this._bAutocompleteEnabled){return;}if(!this._bSuggestionItemTapped&&!this._bSuggestionItemChanged&&this._oProposedItem){if(this._bHasTabularSuggestions){this._oInput.setSelectionRow(this._oProposedItem,true);}else{this._oInput.setSelectionItem(this._oProposedItem,true);}}if(this._oProposedItem&&document.activeElement===this._oInput.getFocusDomRef()){var i=this._oInput.getValue().length;this._oInput.selectText(i,i);}this._resetTypeAhead();};w.prototype._resetTypeAhead=function(){this._oProposedItem=null;this._sProposedItemText=null;this._sTypedInValue='';this._bSuggestionItemTapped=false;this._bSuggestionItemChanged=false;};w.prototype._formatTypedAheadValue=function(N){return this._sTypedInValue.concat(N.substring(this._sTypedInValue.length,N.length));};w.prototype._onsapright=function(){var i=this._oInput,x=i.getValue();if(!this._bAutocompleteEnabled){return;}if(this._sTypedInValue!==x){this._sTypedInValue=x;i.fireLiveChange({value:x,newValue:x});}};w.prototype.updateValueState=function(i,x,y){var z=y&&i!==v.None;x=x||V.getAdditionalText(i);if(this._oPopupInput){this._oPopupInput.setValueState(i);}this._setValueStateText(x);this._showValueStateText(z);this._alignValueStateStyles(i);return this;};w.prototype._getPickerValueStateText=function(){if(!this._oPickerValueStateText){this._oPickerValueStateText=new k({width:"100%"});}return this._oPickerValueStateText;};w.prototype._showValueStateText=function(i){if(this._oPickerValueStateText){this._oPickerValueStateText.setVisible(i);}};w.prototype._setValueStateText=function(i){var x;x=this._getPickerValueStateText();if(x){x.setText(i);if(this._oSimpleFixFlex){this._oSimpleFixFlex.setFixContent(this._oPickerValueStateText);}}};w.prototype._alignValueStateStyles=function(i){var x=t+"ValueState",O=t+this._sOldValueState+"State",y=t+i+"State";if(this._oPickerValueStateText){this._oPickerValueStateText.addStyleClass(x);this._oPickerValueStateText.removeStyleClass(O);this._oPickerValueStateText.addStyleClass(y);}this._sOldValueState=i;};w.prototype.addFlexContent=function(i){if(this._oSimpleFixFlex){this._oSimpleFixFlex.addFlexContent(i);}};return w;});
